# AIへのプロンプト：コマンドプロンプトベースのチャットアプリ開発

以下の要件と構想に基づき、コマンドプロンプト（ターミナル）上で動作するチャットアプリケーションを開発してください。

## 1. アプリケーションの概要

* **名称**: コマンドプロンプトチャット (仮称)
* **ターゲット環境**: Windowsのコマンドプロンプト、macOS/Linuxのターミナル
* **コンセプト**: 無料重視で、技術的な興味を持つユーザー向けのユニークなテキストベースチャット体験を提供する。
* **主要な機能**:
    * リアルタイムチャット
    * ユーザー認証とアカウント管理
    * 管理者によるユーザー管理機能
    * 整形されたメッセージ表示とカラーリング

## 2. 開発における制約と優先順位

* **無料重視**: 可能な限り無料枠内で運用できる技術スタックとサービスを選択する。
* **サーバー管理不要**: 複雑なサーバー構築や運用は避ける。
* **リアルタイム性**: メッセージの送受信はリアルタイムで行われること。
* **配布の容易性**: ユーザーが手軽にアプリを利用開始できること。
* **プロジェクトの軽量化**: 不要なファイルやフォルダは削除し、プロジェクトを可能な限り軽量に保つ。

## 3. 主要な技術スタック

以下の技術スタックを必須とします。

* **バックエンド/データベース/リアルタイム機能**: **Supabase**
    * PostgreSQLベースのリレーショナルデータベースとして使用。
    * Supabase Realtime機能を利用し、データベースの変更をリアルタイムでクライアントにプッシュ通知する。
    * Supabase Authenticationを利用し、ユーザーのサインアップ、サインイン、セッション管理を行う。
    * ストレージ機能は、現時点では使用しない（テキストチャットのため）。
* **クライアントサイド (開発言語)**: **Node.jsのみ**
    * JavaScript/TypeScriptでクライアントアプリケーションロジックを実装する。
    * **HTML、CSS、その他のWebブラウザ言語は一切使用しない**。
    * Supabase JavaScript SDK を使用してバックエンドと連携する。
* **クライアントサイド (CUIライブラリ)**: **`blessed`** (npmパッケージ)
    * ターミナル上で高度なUI（固定エリア、スクロール可能なログ、入力ボックスなど）を構築するために使用する。
    * `blessed`の`tags: true`オプションを有効にし、カラータグを解釈できるようにする。
* **配布ツール**: **`pkg`** (npmパッケージ)
    * Node.jsアプリケーションを、Node.jsランタイムがインストールされていない環境でも動作する単一の実行ファイル（Windows, macOS, Linux向け）にパッケージ化する。これにより、配布体制を確立する。

## 4. 画面構成とUI/UX設計

ターミナルの特性を活かし、情報が整理され、操作しやすいUIを設計する。

* **全体レイアウト**:
    * **上部**: チャットメッセージが表示される「チャット表示エリア」。このエリアは画面上部に固定され、新しいメッセージが追加されると自動的にスクロールする。
    * **下部**: 常に画面の最下部に固定される「メッセージ入力エリア」。ユーザーはここにコマンドやメッセージを入力する。
    * **最下部（オプション）**: アプリの状態（例: 接続状況、現在のユーザー名）、簡単なヘルプテキスト、またはシステムからのお知らせなどが表示されるステータスエリア。
* **メッセージ表示形式**:
    各メッセージは以下の厳密に整形された形式で一列に揃えて表示される。
    ```
    | UserName   | 000.000.0.000 | メッセージの内容がここに表示されます。
    |            |               | 長いメッセージは自動でここで改行されます。
    | System     | 0.0.0.0       | ユーザーがチャットに参加しました。
    ```
    * **`UserName`**:
        * ユーザー名には**10文字の文字数上限**を設ける。
        * 上限より短い場合は右側にスペースを追加してパディングし、長さを揃える。
        * 上限を超える場合は、切り詰めて末尾に**省略記号（`…`）**を追加する。
        * これにより、ユーザー名列の幅を固定し、最初の縦棒の位置を常に揃える。
    * **`000.000.0.000`**:
        * IPアドレス風のユーザーID。**固定長（15文字）**として扱う（例: "XXX.XXX.XXX.XXX"）。
        * これにより、IPアドレス風ID列の幅を固定し、その後の縦棒の位置も常に揃える。
    * **`メッセージ`**:
        * ターミナルの残りの表示幅に合わせて、長いメッセージは自動的に**改行（ワードラップ）**される。
        * メッセージが2行目以降に続く場合、その行の先頭は、ユーザー名とIPアドレス部分と同じだけの空白（インデント）が入ることで、メッセージの続きであることが視覚的に分かりやすくする。
        * これにより、一番右端の縦棒も常に一列に揃える。
* **メッセージへの色付け**:
    * メッセージ本文内で `$#RRGGBBテキスト$` のようなカスタムタグを使用することで、特定の部分に色を付けることを可能にする（例: `$#FF0000こんにちは$` で「こんにちは」が赤色に表示される）。
    * クライアントサイドのNode.jsで、このカスタムタグを`blessed`が解釈できる`{#RRGGBB-fg}テキスト{/#RRGGBB-fg}`形式に変換する処理を実装する。
* **入力プロンプト**:
    * メッセージ入力エリアの先頭には、常に `>>` のようなプロンプトを表示し、その後にカーソルが点滅する。
* **お知らせ機能**:
    * チャットの流れの中にシステムメッセージとしてお知らせを挿入する（例: 「ユーザーXがチャットに参加しました」）。
    * 必要であれば、ステータスエリアに短い通知を表示することも検討する。

## 5. コマンド機能

ユーザーがメッセージ入力エリアから特定のコマンドを入力することで、アプリケーションの操作や管理を行うことができるようにする。

* **コマンドの形式**: `/<command> [arguments]` の形式を推奨（例: `/login user pass`）。これにより、通常のメッセージとコマンドを区別する。

* **ユーザーコマンド**:
    * **`/register <username> <password>`**: 新しいユーザーアカウントをSupabaseに登録する。
    * **`/login <username> <password>`**: 登録済みユーザーとしてSupabase認証を行い、ログインする。
    * **`/logout`**: 現在のセッションからログアウトし、匿名ユーザーまたは未ログインの状態に戻る。
    * **`/name <new_name>`**: 自分の表示名を変更する。IPアドレス風IDは変わらない。
    * **`/help`**: 利用可能なコマンドの一覧と簡単な説明を表示する。

* **管理者コマンド**:
    特定の権限を持つユーザーのみが利用できる。これらのコマンドは、不正行為への対応やチャットルームの健全な運営に役立つ。管理者権限はSupabaseのデータベース（例: `user_roles`テーブル）で管理し、SupabaseのRow Level Security (RLS) を活用してアクセス制御を実装する。
    * **`/admin <password>`**: 管理者モードに入るためのパスワード認証コマンド。認証成功後、管理者コマンドが利用可能になる。
    * **`/add <ip_id> <role>`**: 指定したIPアドレス風IDのユーザーに特定の役割（例: `moderator`, `admin`）を付与する。
    * **`/rm <ip_id> <role>`**: 指定したIPアドレス風IDのユーザーから特定の役割を削除する（または、引数なしで全ての役割を削除）。
    * **`/kick <ip_id>`**: 指定したIPアドレス風IDのユーザーを一時的にチャットから切断・追放する。
    * **`/ban <ip_id>`**: 指定したIPアドレス風IDのユーザーを永続的にチャットからブロックし、再参加を禁止する。これはSupabaseデータベースにブロックリストとして記録する。
    * **`/ipban <ip_id>`**: `ban`コマンドよりも厳格な措置で、指定したIPアドレス風IDでのアクセス自体を禁止する。クライアント側のロジックだけでなく、Supabase Functionsなどを用いたバックエンドでの制御も検討する。

## 6. その他考慮事項

* **IPアドレス風IDの生成**: アプリケーション起動時（または匿名参加時）に、プライバシーに配慮したランダムなIPアドレス形式の文字列を生成し、ユーザーの表示IDとして利用する。これは実際のIPアドレスとは無関係とする。
* **エラーハンドリング**: コマンドの失敗、ネットワークエラー、Supabaseとの通信エラーなど、適切なエラーメッセージをユーザーに表示する。
* **セキュリティ**: 管理者パスワードの安全な管理、SupabaseのRLSの適切な設定、クライアントサイドでの認証情報の安全な取り扱いを徹底する。
