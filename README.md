# 前提
このアプリケーションは、**Go言語**で開発され、コンパイルによって単一の実行ファイルとして配布されることを前提とします。これにより、ユーザーはGoランタイムがインストールされていない環境でもアプリを直接実行できます。

# AIへのプロンプト：コマンドプロンプトベースのチャットアプリ開発 (Go版)

以下の要件と構想に基づき、コマンドプロンプト（ターミナル）上で動作するチャットアプリケーションを開発してください。

## 1. アプリケーションの概要

* **名称**: コマンドプロンプトチャット (Go版)
* **ターゲット環境**: Windowsのコマンドプロンプト、macOS/Linuxのターミナル
* **コンセプト**: 無料重視で、技術的な興味を持つユーザー向けのユニークなテキストベースチャット体験を提供する。
* **主要な機能**:
    * リアルタイムチャット (WebSocket)
    * ユーザー認証とアカウント管理 (ローカル保存)
    * 管理者によるユーザー管理機能
    * 整形されたメッセージ表示とカラーリング
    * **ホストPCによるサーバー機能**: 外部クラウド(Supabase等)を使用せず、ホストPC上でサーバーを起動し、データを管理する。

## 2. 開発における制約と優先順位

* **完全ローカル運用**: 外部BaaSやDBサービスを使用せず、全てローカル環境で完結させる。
* **シングルバイナリ**: Goの特性を活かし、サーバー・クライアント共に単一の実行ファイルとして配布可能にする（あるいは `server` と `client` の2つのバイナリ）。
* **リアルタイム性**: WebSocketを使用し、低遅延なメッセージ送受信を実現する。
* **プロジェクトの軽量化**: 依存関係を最小限に抑える。

## 3. 主要な技術スタック

以下の技術スタックを必須とします。

* **開発言語**: **Go (Golang)**
* **アーキテクチャ**: **クライアント・サーバーモデル**
    * **サーバー**: ホストPC上で動作し、WebSocket接続を受け付ける。
    * **クライアント**: TUI (Text User Interface) を提供し、サーバーに接続する。
* **データ保存**: **ローカルJSONファイル**
    * `users.json`: ユーザー情報（ユーザー名、ハッシュ化されたパスワード、権限、IP風ID）
    * `messages.json`: チャット履歴
    * これらをサーバー実行ディレクトリに保存・読み込みする。
* **通信プロトコル**: **WebSocket** (`github.com/gorilla/websocket` 推奨)
* **クライアントサイド (TUIライブラリ)**: **`bubbletea`** (`github.com/charmbracelet/bubbletea`)
    * Go言語でモダンなTUIを構築するための標準的なライブラリ。
    * `lipgloss` (`github.com/charmbracelet/lipgloss`) を使用してスタイリングを行う。

## 4. 画面構成とUI/UX設計

ターミナルの特性を活かし、情報が整理され、操作しやすいUIを設計する。

* **全体レイアウト**:
    * **上部**: チャットメッセージが表示される「チャット表示エリア」。
    * **下部**: 常に画面の最下部に固定される「メッセージ入力エリア」。
    * **最下部（オプション）**: ステータスバー（接続先サーバー、ログインユーザー名など）。
* **メッセージ表示形式**:
    各メッセージは以下の厳密に整形された形式で一列に揃えて表示される。
    ```
    | UserName   | 000.000.0.000 | メッセージの内容がここに表示されます。
    |            |               | 長いメッセージは自動でここで改行されます。
    | System     | 0.0.0.0       | ユーザーがチャットに参加しました。
    ```
    * **`UserName`**: 10文字固定（パディング/切り詰め）。
    * **`000.000.0.000`**: IPアドレス風ID。15文字固定。
    * **`メッセージ`**: ワードラップ対応。2行目以降はインデント。
* **メッセージへの色付け**:
    * メッセージ本文内で `$#RRGGBBテキスト$` のようなカスタムタグを使用可能にする。
    * クライアント側でパースし、`lipgloss` 等を用いて色付け表示する。
* **入力プロンプト**: `>>` プロンプトと点滅カーソル。

## 5. コマンド機能

メッセージ入力エリアから `/` で始まるコマンドを入力して操作する。

* **ユーザーコマンド**:
    * **`/register <username> <password>`**: サーバーの `users.json` に新規登録する。
    * **`/login <username> <password>`**: サーバーで認証を行い、トークン等を発行してログイン状態にする。
    * **`/logout`**: ログアウトする。
    * **`/name <new_name>`**: 表示名を変更する。
    * **`/help`**: ヘルプ表示。

* **管理者コマンド**:
    `users.json` 内で管理者権限を持つユーザーのみ実行可能。
    * **`/admin <password>`**: 管理者権限への昇格（必要な場合。最初からadminロールを持っているなら不要かもしれないが、仕様として残す）。
    * **`/add <ip_id> <role>`**: 権限付与。
    * **`/rm <ip_id> <role>`**: 権限剥奪。
    * **`/kick <ip_id>`**: 強制切断。
    * **`/ban <ip_id>`**: `users.json` (または `banned.json`) に記録し、接続を拒否する。

## 6. その他考慮事項

* **IPアドレス風IDの生成**: ユーザー登録時にランダム生成し、`users.json` に保存して固定する。
* **エラーハンドリング**: サーバー接続エラー、認証エラーなどをTUI上で適切に通知する。
* **セキュリティ**: パスワードは必ずハッシュ化して保存すること（平文保存禁止）。
